<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>FX 自動売買パネル</title>
  <link rel="stylesheet" href="style.css" />

  <!-- OneSignal Push 初期化 -->
  <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async=""></script>
  <script>
    window.OneSignal = window.OneSignal || [];
    OneSignal.push(function () {
      OneSignal.init({
        appId: "478eae6e-2a31-446e-8b47-b596293afa68",
        notifyButton: { enable: true }
      });
      OneSignal.showSlidedownPrompt(); // 通知許可プロンプト
    });
  </script>
</head>
<body>
  <h1>FX 自動売買パネル</h1>

  <section id="system">
    <label>
      <input type="checkbox" id="toggleSystem" />
      <span id="systemStatus">停止中</span>
    </label>
    <p>最終エントリー: <span id="lastEntry">--</span></p>
  </section>

  <section id="summary">
    <p>勝率: <span id="statWinRate">--%</span></p>
    <p>合計pips: <span id="statPips">--</span></p>
    <p>平均RR: <span id="statRR">--</span></p>
  </section>

  <section id="status">
    <p>通知: <span id="notifyStatus">未確認</span></p>
    <p>CSV: <span id="csvStatus">未確認</span></p>
  </section>

  <!-- データ埋め込み -->
  <script>
    const tradeLog = [
      { date: "2025-06-24", result: 1, pips: 30.0, rr: 2.0, time: "21:50" },
      { date: "2025-06-24", result: 0, pips: -15.0, rr: 0.5, time: "22:10" }
    ];
    const balance = 231000;
  </script>

  <!-- メインロジック -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const toggle = document.getElementById("toggleSystem");
      const status = document.getElementById("systemStatus");
      const notify = document.getElementById("notifyStatus");
      const csv = document.getElementById("csvStatus");
      const lastEntry = document.getElementById("lastEntry");

      function isWithinTradingHours() {
        const now = new Date();
        const nowMinutes = now.getHours() * 60 + now.getMinutes();
        const start = 9 * 60;
        const end = 23 * 60 + 30;
        return nowMinutes >= start && nowMinutes <= end;
      }

      const isUserActive = localStorage.getItem("systemActive") === "true";
      const isActive = isUserActive && isWithinTradingHours();
      toggle.checked = isUserActive;
      updateStatus(isActive);

      toggle.addEventListener("change", () => {
        const active = toggle.checked;
        localStorage.setItem("systemActive", active);
        updateStatus(active && isWithinTradingHours());
      });

      function updateStatus(active) {
        if (!isWithinTradingHours()) {
          status.textContent = "停止中（時間外）";
          status.className = "off";
        } else {
          status.textContent = active ? "稼働中" : "停止中";
          status.className = active ? "on" : "off";
        }
      }

      function sendPushNotification(message) {
        if (window.OneSignal) {
          OneSignal.Notifications.isPushNotificationsEnabled().then(function (enabled) {
            if (enabled) {
              OneSignal.sendSelfNotification(
                "エントリー通知",
                message,
                window.location.href,
                null
              );
            } else {
              console.log("通知が許可されていません");
            }
          });
        }
      }

      try {
        if (!Array.isArray(tradeLog)) throw new Error();
        csv.textContent = "OK";

        let wins = 0, total = 0, totalPips = 0, totalRR = 0;
        tradeLog.forEach(row => {
          total++;
          totalPips += row.pips;
          totalRR += row.rr;
          if (row.result === 1) wins++;
        });

        document.getElementById("statWinRate").textContent = `${((wins / total) * 100).toFixed(1)}%`;
        document.getElementById("statPips").textContent = totalPips.toFixed(1);
        document.getElementById("statRR").textContent = (totalRR / total).toFixed(2);

        const last = tradeLog[tradeLog.length - 1];
        const message = `エントリー発生：${last.date} ${last.result === 1 ? 'L' : 'S'} ${last.time || '--:--'}`;
        lastEntry.textContent = message;
        sendPushNotification(message);
      } catch {
        csv.textContent = "エラー";
      }

      notify.textContent = "有効";
    });
  </script>
</body>
</html>
